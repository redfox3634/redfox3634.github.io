(function(e){e.fn.wPaint.menus.text={img:"plugins/text/img/icons-menu-text.png",items:{bold:{icon:"toggle",title:"Bold",index:0,callback:function(e){this.setFontBold(e)}},italic:{icon:"toggle",title:"Italic",index:1,callback:function(e){this.setFontItalic(e)}},fontSize:{title:"Font Size",icon:"select",range:[8,9,10,12,14,16,20,24,30],value:12,callback:function(e){this.setFontSize(e)}},fontFamily:{icon:"select",title:"Font Family",range:["Arial","Courier","Times","Verdana"],useRange:true,value:"Arial",callback:function(e){this.setFontFamily(e)}}}};e.fn.wPaint.menus.main.items.text={icon:"menu",after:"pencil",title:"Text",index:7,callback:function(){this.setMode("text")}};e.extend(e.fn.wPaint.defaults,{fontSize:"20",fontFamily:"Arial",fontBold:false,fontItalic:false,fontUnderline:false});e.fn.wPaint.extend({generate:function(){this.$textCalc=e("<div></div>").hide();this.$textInput=e('<textarea class="wPaint-text-input" spellcheck="false"></textarea>').on("mousedown",this._stopPropagation).css({position:"absolute"}).hide();e("body").append(this.$textCalc);this.$el.append(this.$textInput);this.menus.all.text=this._createMenu("text")},_init:function(){function n(){t._drawTextIfNotEmpty();t.$textInput.hide();t.$canvasTemp.hide()}var t=this;for(var r in this.menus.all){this.menus.all[r].$menu.on("click",n).on("mousedown",this._stopPropagation)}e(document).on("mousedown",n)},setFillStyle:function(e){this.$textInput.css("color",e)},setFontSize:function(e){this.options.fontSize=parseInt(e,10);this._setFont({fontSize:e+"px",lineHeight:e+"px"});this.menus.all.text._setSelectValue("fontSize",e)},setFontFamily:function(e){this.options.fontFamily=e;this._setFont({fontFamily:e});this.menus.all.text._setSelectValue("fontFamily",e)},setFontBold:function(e){this.options.fontBold=e;this._setFont({fontWeight:e?"bold":""})},setFontItalic:function(e){this.options.fontItalic=e;this._setFont({fontStyle:e?"italic":""})},setFontUnderline:function(e){this.options.fontUnderline=e;this._setFont({fontWeight:e?"underline":""})},_setFont:function(e){this.$textInput.css(e);this.$textCalc.css(e)},_drawTextDown:function(e){this._drawTextIfNotEmpty();this._drawShapeDown(e,1);this.$textInput.css({left:e.pageX-1,top:e.pageY-1,width:0,height:0}).show().focus()},_drawTextMove:function(e){this._drawShapeMove(e,1);this.$textInput.css({left:e.left-1,top:e.top-1,width:e.width,height:e.height})},_drawTextIfNotEmpty:function(){if(this.$textInput.val()!==""){this._drawText()}},_drawText:function(){var e="",t=this.$textInput.val().split("\n"),n=[],r=this.$textInput.width()-2,i=0,s=0,o=this.$textInput.position(),u=o.left+1,a=o.top+1,f,l,c,h;if(this.options.fontItalic){e+="italic "}if(this.options.fontBold){e+="bold "}e+=this.options.fontSize+"px "+this.options.fontFamily;for(f=0,l=t.length;f<l;f++){this.$textCalc.html("");s=0;for(c=0,h=t[0].length;c<h;c++){i=this.$textCalc.append(t[f][c]).width();if(i>r){n.push(t[f].substring(s,c));s=c;this.$textCalc.html(t[f][c])}}if(s!==c){n.push(t[f].substring(s,c))}}t=this.$textInput.val(n.join("\n")).val().split("\n");for(f=0,l=t.length;f<l;f++){this.ctx.fillStyle=this.options.fillStyle;this.ctx.textBaseline="top";this.ctx.font=e;this.ctx.fillText(t[f],u,a);a+=this.options.fontSize}this.$textInput.val("");this._addUndo()}})})(jQuery)